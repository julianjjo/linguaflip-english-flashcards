---
import MainLayout from '../layouts/MainLayout.astro';
import Header from '../components/Header.astro';
import Sidebar from '../components/Sidebar.astro';

// Importar componentes React
import StudyHeatmap from '../../components/StudyHeatmap.tsx';
import ThemeToggle from '../components/ThemeToggle.tsx';
import AppProvider from '../components/AppProvider.tsx';

// Importar stores
import { studyHistoryStore, progressStatsStore } from '../stores/study.ts';
import { flashcardsStore } from '../stores/flashcards.ts';

// Datos de ejemplo para desarrollo
const sampleStudySessions = [
  {
    id: 'session_1',
    date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
    cardsReviewed: 15,
    correctAnswers: 12,
    totalTime: 25
  },
  {
    id: 'session_2',
    date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
    cardsReviewed: 20,
    correctAnswers: 18,
    totalTime: 35
  },
  {
    id: 'session_3',
    date: new Date().toISOString(),
    cardsReviewed: 10,
    correctAnswers: 9,
    totalTime: 18
  }
];

// Inicializar con datos de ejemplo
if (studyHistoryStore.get().length === 0) {
  studyHistoryStore.set(sampleStudySessions);
}
---

<MainLayout
  title="Dashboard - LinguaFlip"
  description="Visualiza tu progreso de aprendizaje de inglés con estadísticas detalladas y análisis de rendimiento"
>
  <!-- SEO Meta Tags -->
  <meta property="og:title" content="Dashboard de Progreso - LinguaFlip" />
  <meta property="og:description" content="Analiza tu progreso de aprendizaje de inglés con métricas detalladas" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Dashboard - LinguaFlip" />
  <meta name="twitter:description" content="Métricas y estadísticas de tu aprendizaje" />

  <!-- Schema.org structured data -->
  <script type="application/ld+json" set:html={
    JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "LinguaFlip Dashboard",
      "description": "Dashboard de análisis de progreso para aprendizaje de inglés",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web Browser"
    })
  } />

  <AppProvider client:only="react">
    <div class="min-h-screen bg-gradient-to-br from-primary-50 via-white to-secondary-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900">
      <div class="flex">
        <!-- Main Content -->
        <main class="flex-1 p-6 lg:pl-72">
          <div class="max-w-7xl mx-auto">
          <!-- Page Header -->
          <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-2">
                  Dashboard de Progreso
                </h1>
                <p class="text-neutral-600 dark:text-neutral-300">
                  Analiza tu progreso y mantén la motivación en tu aprendizaje
                </p>
              </div>

              <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <ThemeToggle variant="icon" size="md" client:load />

                <a
                  href="/study"
                  class="bg-primary-600 hover:bg-primary-700 dark:bg-primary-700 dark:hover:bg-primary-600 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 flex items-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                  Continuar Estudiando
                </a>
              </div>
            </div>
          </div>

          <!-- Stats Overview -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Cards -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-neutral-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-neutral-600 dark:text-neutral-300">Total de Tarjetas</p>
                  <p class="text-2xl font-bold text-neutral-900 dark:text-neutral-100" id="total-cards">0</p>
                </div>
                <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Cards Mastered -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-neutral-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-neutral-600 dark:text-neutral-300">Tarjetas Dominadas</p>
                  <p class="text-2xl font-bold text-success-600 dark:text-success-400" id="mastered-cards">0</p>
                </div>
                <div class="w-12 h-12 bg-success-100 dark:bg-success-900 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-success-600 dark:text-success-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Current Streak -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-neutral-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-neutral-600 dark:text-neutral-300">Racha Actual</p>
                  <p class="text-2xl font-bold text-accent-600 dark:text-accent-400" id="current-streak">0</p>
                </div>
                <div class="w-12 h-12 bg-accent-100 dark:bg-accent-900 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-accent-600 dark:text-accent-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Study Time Today -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-neutral-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-neutral-600 dark:text-neutral-300">Tiempo Hoy</p>
                  <p class="text-2xl font-bold text-secondary-600 dark:text-secondary-400" id="study-time-today">0m</p>
                </div>
                <div class="w-12 h-12 bg-secondary-100 dark:bg-secondary-900 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-secondary-600 dark:text-secondary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts and Heatmap -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Study Heatmap -->
            <div class="lg:col-span-2">
              <div id="study-heatmap-container">
                <!-- StudyHeatmap component will be rendered here -->
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-neutral-200">
              <h3 class="text-lg font-semibold text-neutral-900 mb-4">Actividad Reciente</h3>
              <div class="space-y-4" id="recent-activity">
                <!-- Recent sessions will be populated here -->
              </div>
              <div class="mt-4 pt-4 border-t border-neutral-200">
                <a
                  href="/study"
                  class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center gap-2"
                >
                  Ver todas las sesiones
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </div>
          </div>

          <!-- Performance Metrics -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Accuracy Chart -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-neutral-200">
              <h3 class="text-lg font-semibold text-neutral-900 mb-4">Precisión por Dificultad</h3>
              <div class="space-y-4" id="accuracy-metrics">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-600">Fácil</span>
                  <div class="flex-1 mx-4">
                    <div class="w-full bg-neutral-200 rounded-full h-2">
                      <div class="bg-success-500 h-2 rounded-full" style="width: 85%"></div>
                    </div>
                  </div>
                  <span class="text-sm font-medium text-neutral-900">85%</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-600">Medio</span>
                  <div class="flex-1 mx-4">
                    <div class="w-full bg-neutral-200 rounded-full h-2">
                      <div class="bg-warning-500 h-2 rounded-full" style="width: 72%"></div>
                    </div>
                  </div>
                  <span class="text-sm font-medium text-neutral-900">72%</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-neutral-600">Difícil</span>
                  <div class="flex-1 mx-4">
                    <div class="w-full bg-neutral-200 rounded-full h-2">
                      <div class="bg-error-500 h-2 rounded-full" style="width: 58%"></div>
                    </div>
                  </div>
                  <span class="text-sm font-medium text-neutral-900">58%</span>
                </div>
              </div>
            </div>

            <!-- Study Goals -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-neutral-200">
              <h3 class="text-lg font-semibold text-neutral-900 mb-4">Metas de Estudio</h3>
              <div class="space-y-4" id="study-goals">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-neutral-900">Tarjetas Diarias</p>
                    <p class="text-xs text-neutral-600">10 de 20 completadas</p>
                  </div>
                  <div class="w-12 h-12 relative">
                    <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 36 36">
                      <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                      <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="50, 100"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <span class="text-xs font-medium text-neutral-900">50%</span>
                    </div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-neutral-900">Tiempo de Estudio</p>
                    <p class="text-xs text-neutral-600">25m de 45m completados</p>
                  </div>
                  <div class="w-12 h-12 relative">
                    <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 36 36">
                      <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e5e7eb" stroke-width="2"/>
                      <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" stroke-width="2" stroke-dasharray="55, 100"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <span class="text-xs font-medium text-neutral-900">55%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="bg-white rounded-xl shadow-lg p-6 border border-neutral-200">
            <h3 class="text-lg font-semibold text-neutral-900 mb-4">Acciones Rápidas</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <a
                href="/study"
                class="flex items-center gap-3 p-4 bg-primary-50 hover:bg-primary-100 rounded-lg transition-colors duration-200"
              >
                <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-neutral-900">Continuar Estudiando</p>
                  <p class="text-sm text-neutral-600">Revisa tus flashcards</p>
                </div>
              </a>

              <a
                href="/data"
                class="flex items-center gap-3 p-4 bg-secondary-50 hover:bg-secondary-100 rounded-lg transition-colors duration-200"
              >
                <div class="w-10 h-10 bg-secondary-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 12l2 2 4-4" />
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-neutral-900">Gestionar Datos</p>
                  <p class="text-sm text-neutral-600">Importar/exportar tarjetas</p>
                </div>
              </a>

              <a
                href="/settings"
                class="flex items-center gap-3 p-4 bg-accent-50 hover:bg-accent-100 rounded-lg transition-colors duration-200"
              >
                <div class="w-10 h-10 bg-accent-100 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-neutral-900">Configuración</p>
                  <p class="text-sm text-neutral-600">Personalizar experiencia</p>
                </div>
              </a>
            </div>
          </div>
          </div>
        </main>
      </div>
    </div>
  </AppProvider>

  <!-- Dashboard Script -->
  <script>
    import { studyHistoryStore, progressStatsStore } from '../stores/study.ts';
    import { flashcardsStore } from '../stores/flashcards.ts';
    import StudyHeatmap from '../../components/StudyHeatmap.tsx';
    import { createRoot } from 'react-dom/client';

    class DashboardManager {
      constructor() {
        this.init();
      }

      init() {
        this.loadStats();
        this.renderHeatmap();
        this.renderRecentActivity();
        this.setupRealTimeUpdates();
      }

      loadStats() {
        const stats = progressStatsStore.get();
        const flashcards = flashcardsStore.get();

        // Update stats display
        document.getElementById('total-cards').textContent = flashcards.length.toString();
        document.getElementById('mastered-cards').textContent = stats.cardsMastered.toString();
        document.getElementById('current-streak').textContent = stats.currentStreak.toString();

        // Calculate today's study time
        const today = new Date().toDateString();
        const sessions = studyHistoryStore.get();
        const todaySessions = sessions.filter(session =>
          new Date(session.date).toDateString() === today
        );
        const todayTime = todaySessions.reduce((sum, session) => sum + session.totalTime, 0);
        document.getElementById('study-time-today').textContent = `${todayTime}m`;
      }

      renderHeatmap() {
        const container = document.getElementById('study-heatmap-container');
        if (!container) return;

        const sessions = studyHistoryStore.get();

        // Clear previous content
        container.innerHTML = '';

        // Create React root and render StudyHeatmap
        const root = createRoot(container);
        root.render(
          React.createElement(StudyHeatmap, {
            studySessions: sessions,
            months: 6
          })
        );
      }

      renderRecentActivity() {
        const container = document.getElementById('recent-activity');
        if (!container) return;

        const sessions = studyHistoryStore.get()
          .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
          .slice(0, 5);

        container.innerHTML = sessions.map(session => `
          <div class="flex items-center justify-between py-2">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-medium text-neutral-900">
                  ${session.cardsReviewed} tarjetas estudiadas
                </p>
                <p class="text-xs text-neutral-600">
                  ${new Date(session.date).toLocaleDateString('es-ES')}
                </p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-neutral-900">${session.totalTime}m</p>
              <p class="text-xs text-neutral-600">
                ${Math.round((session.correctAnswers / session.cardsReviewed) * 100)}% precisión
              </p>
            </div>
          </div>
        `).join('');
      }

      setupRealTimeUpdates() {
        // Update stats every 30 seconds
        setInterval(() => {
          this.loadStats();
        }, 30000);
      }
    }

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new DashboardManager();
    });
  </script>

  <style>
    /* Custom styles for the dashboard */
    .stat-card {
      transition: transform 0.2s ease-in-out;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    /* Progress ring animation */
    @keyframes progress-ring {
      from {
        stroke-dasharray: 0 100;
      }
      to {
        stroke-dasharray: var(--progress) 100;
      }
    }

    .progress-ring {
      animation: progress-ring 1s ease-out forwards;
    }

    /* Responsive grid adjustments */
    @media (max-width: 768px) {
      .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
        grid-template-columns: repeat(2, 1fr);
      }

      .lg\\:col-span-2 {
        grid-column: span 2;
      }
    }
  </style>
</MainLayout>
let a=[],v=(e,i)=>{let n=[],t={get(){return t.lc||t.listen(()=>{})(),t.value},l:i||0,lc:0,listen(l,u){return t.lc=n.push(l,u||t.l)/2,()=>{let f=n.indexOf(l);~f&&(n.splice(f,2),--t.lc||t.off())}},notify(l,u){let f=!a.length;for(let s=0;s<n.length;s+=2)a.push(n[s],n[s+1],t.value,l,u);if(f){for(let s=0;s<a.length;s+=5){let d;for(let r=s+1;!d&&(r+=5)<a.length;)a[r]<a[s+1]&&(d=a.push(a[s],a[s+1],a[s+2],a[s+3],a[s+4]));d||a[s](a[s+2],a[s+3],a[s+4])}a.length=0}},off(){},set(l){let u=t.value;u!==l&&(t.value=l,t.notify(u))},subscribe(l,u){let f=t.listen(l,u);return l(t.value),f},value:e};return t};let N=(e,i,n,t)=>(e.events=e.events||{},e.events[n+10]||(e.events[n+10]=t(l=>{e.events[n].reduceRight((u,f)=>(f(u),u),{shared:{},...l})})),e.events[n]=e.events[n]||[],e.events[n].push(i),()=>{let l=e.events[n],u=l.indexOf(i);l.splice(u,1),l.length||(delete e.events[n],e.events[n+10](),delete e.events[n+10])}),U=1e3,h=(e,i)=>N(e,t=>{let l=i(t);l&&e.events[6].push(l)},5,t=>{let l=e.listen;e.listen=(...f)=>(!e.lc&&!e.active&&(e.active=!0,t()),l(...f));let u=e.off;return e.events[6]=[],e.off=()=>{u(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let f of e.events[6])f();e.events[6]=[]}},U)},()=>{e.listen=l,e.off=u}}),O=(e,i,n)=>{Array.isArray(e)||(e=[e]);let t,l=0,u=()=>{let d=e.map(r=>r.get());if(t===void 0||d.some((r,T)=>r!==t[T])){let r=++l;t=d;let T=i(...d);T&&T.then&&T.t?T.then(p=>{r===l&&f.set(p)}):f.set(T)}},f=v(void 0,Math.max(...e.map(d=>d.l))+1),s=u;return h(f,()=>{let d=e.map(r=>r.listen(s,-1/f.l));return u(),()=>{for(let r of d)r()}}),f},M=(e,i)=>O(e,i);function c(e,i,n){let t=new Set([...i,void 0]);return e.listen((l,u,f)=>{t.has(f)&&n(l,u,f)})}let m=(e={})=>{let i=v(e);return i.setKey=function(n,t){let l=i.value;typeof t>"u"&&n in i.value?(i.value={...i.value},delete i.value[n],i.notify(l,n)):i.value[n]!==t&&(i.value={...i.value,[n]:t},i.notify(l,n))},i};export{v as a,M as c,c as l,m};
